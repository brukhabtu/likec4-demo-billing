name: Federation

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  # Change to 'main' once federation ships to upstream likec4
  LIKEC4_REF: feat/federated-registry
  LIKEC4_REPO: brukhabtu/likec4

jobs:
  composition-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Build likec4 CLI from fork
        run: |
          git clone --depth 1 --branch $LIKEC4_REF https://github.com/$LIKEC4_REPO.git /tmp/likec4
          cd /tmp/likec4
          HUSKY=0 pnpm install --frozen-lockfile
          pnpm generate
          pnpm --filter @likec4/core --filter @likec4/config --filter @likec4/federation --filter @likec4/language-server --filter @likec4/layouts --filter @likec4/generators --filter likec4 build
          echo "LIKEC4_CLI=/tmp/likec4/packages/likec4/bin/likec4.mjs" >> "$GITHUB_ENV"

      - name: Read version
        id: version
        run: echo "value=$(cat version)" >> "$GITHUB_OUTPUT"

      - name: Build manifest
        run: node $LIKEC4_CLI federation build . --version ${{ steps.version.outputs.value }} --output manifest.json

      - name: Fetch registry
        run: curl -fsSL https://raw.githubusercontent.com/brukhabtu/likec4-demo-registry/main/registry.json -o registry.json

      - name: Check for breaking changes
        run: |
          node -e '
          const fs = require("fs");
          const manifest = JSON.parse(fs.readFileSync("manifest.json", "utf8"));
          const registry = JSON.parse(fs.readFileSync("registry.json", "utf8"));

          const provider = "billing";
          const manifestElements = new Set(Object.keys(manifest.elements || {}));
          let breaking = false;

          for (const [name, consumer] of Object.entries(registry.consumers || {})) {
            const importedFqns = (consumer.imports || {})[provider] || [];
            if (importedFqns.length === 0) continue;

            for (const fqn of importedFqns) {
              if (!manifestElements.has(fqn)) {
                console.error(`BREAKING: Consumer "${name}" imports "${fqn}" from "${provider}", but it no longer exists in the manifest.`);
                breaking = true;
              }
            }
          }

          if (breaking) {
            console.error("\nComposition check failed: breaking changes detected.");
            process.exit(1);
          } else {
            console.log("Composition check passed: no breaking changes detected.");
          }
          '

  publish:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Build likec4 CLI from fork
        run: |
          git clone --depth 1 --branch $LIKEC4_REF https://github.com/$LIKEC4_REPO.git /tmp/likec4
          cd /tmp/likec4
          HUSKY=0 pnpm install --frozen-lockfile
          pnpm generate
          pnpm --filter @likec4/core --filter @likec4/config --filter @likec4/federation --filter @likec4/language-server --filter @likec4/layouts --filter @likec4/generators --filter likec4 build
          echo "LIKEC4_CLI=/tmp/likec4/packages/likec4/bin/likec4.mjs" >> "$GITHUB_ENV"

      - name: Read version
        id: version
        run: echo "value=$(cat version)" >> "$GITHUB_OUTPUT"

      - name: Build manifest
        run: node $LIKEC4_CLI federation build . --version ${{ steps.version.outputs.value }} --output manifest.json

      - name: Read manifest for dispatch
        id: manifest
        run: echo "content=$(cat manifest.json | jq -c .)" >> "$GITHUB_OUTPUT"

      - name: Dispatch to registry
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REGISTRY_PAT }}
          repository: brukhabtu/likec4-demo-registry
          event-type: manifest-update
          client-payload: '{"provider": "billing", "version": "${{ steps.version.outputs.value }}", "manifest": ${{ steps.manifest.outputs.content }}}'
